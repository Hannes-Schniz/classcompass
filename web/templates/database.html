{% extends "base.html" %} {% block title %}Database - ClassCompass Management{%
endblock %} {% block content %}
<div class="page-header">
  <h1>Database Management</h1>
  <p>View and analyze your ClassCompass database contents</p>
</div>

<div class="grid grid-2">
  <div class="card">
    <div class="card-header">üìä Database Tables</div>
    <div class="card-body">
      <div id="tablesList"></div>
      <button onclick="loadTables()" class="btn btn-secondary">
        üîÑ Refresh Tables
      </button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">üîç Quick Query</div>
    <div class="card-body">
      <div class="form-group">
        <label for="quickQuery">SQL Query (SELECT only):</label>
        <textarea
          id="quickQuery"
          class="form-control"
          rows="4"
          placeholder="SELECT * FROM classes LIMIT 10;"></textarea>
      </div>
      <button onclick="executeQuery()" class="btn btn-primary">
        ‚ñ∂Ô∏è Execute Query
      </button>
      <button
        onclick="loadPresetQuery('latest_batch')"
        class="btn btn-secondary">
        üìä Latest Batch
      </button>
      <button
        onclick="loadPresetQuery('class_stats')"
        class="btn btn-secondary">
        üìà Class Stats
      </button>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <span id="tableTitle">üìã Table Data</span>
    <div style="float: right">
      <select id="tableSelect" onchange="loadTableData(this.value)">
        <option value="">Select a table...</option>
      </select>
    </div>
  </div>
  <div class="card-body">
    <div id="tableControls" style="margin-bottom: 1rem; display: none">
      <button onclick="previousPage()" class="btn btn-secondary">
        ‚¨ÖÔ∏è Previous
      </button>
      <span id="pageInfo">Page 1</span>
      <button onclick="nextPage()" class="btn btn-secondary">Next ‚û°Ô∏è</button>
      <select id="perPageSelect" onchange="changePerPage(this.value)">
        <option value="25">25 per page</option>
        <option value="50" selected>50 per page</option>
        <option value="100">100 per page</option>
        <option value="500">500 per page</option>
      </select>
    </div>

    <div id="tableContent">
      <div class="loading">Select a table to view its data</div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">üìà Database Statistics</div>
  <div class="card-body">
    <div id="dbStats">
      <div class="loading">Loading statistics...</div>
    </div>
    <button onclick="loadStats()" class="btn btn-secondary">
      üîÑ Refresh Stats
    </button>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let currentTable = '';
  let currentPage = 1;
  let currentPerPage = 50;
  let totalPages = 1;

  const presetQueries = {
    latest_batch: `SELECT 
            c.*, 
            date(c.date) as formatted_date,
            time(substr(c.startTime, 1, 2) || ':' || substr(c.startTime, 3, 2)) as start_time,
            time(substr(c.endTime, 1, 2) || ':' || substr(c.endTime, 3, 2)) as end_time
        FROM classes c 
        WHERE c.batchID = (SELECT MAX(batchID) FROM classes) 
        ORDER BY c.date, c.startTime`,

    class_stats: `SELECT 
            subject,
            COUNT(*) as total_classes,
            COUNT(DISTINCT date) as unique_dates,
            COUNT(CASE WHEN state = 'CANCELLED' THEN 1 END) as cancelled_count,
            COUNT(CASE WHEN state = 'CHANGED' THEN 1 END) as changed_count
        FROM classes 
        GROUP BY subject 
        ORDER BY total_classes DESC`,
  };

  document.addEventListener('DOMContentLoaded', function () {
    loadTables();
    loadStats();
  });

  function loadTables() {
    fetch('/api/database/tables')
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById(
            'tablesList'
          ).innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
          return;
        }

        const tablesList = document.getElementById('tablesList');
        const tableSelect = document.getElementById('tableSelect');

        let html = '<div class="grid grid-1">';
        data.tables.forEach((table) => {
          html += `
                        <div style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 5px; margin: 0.25rem 0;">
                            <strong>${table}</strong>
                            <button onclick="loadTableData('${table}')" class="btn btn-primary" style="float: right; padding: 0.25rem 0.5rem; font-size: 0.8rem;">View</button>
                        </div>
                    `;
        });
        html += '</div>';
        tablesList.innerHTML = html;

        // Update table select
        tableSelect.innerHTML = '<option value="">Select a table...</option>';
        data.tables.forEach((table) => {
          tableSelect.innerHTML += `<option value="${table}">${table}</option>`;
        });
      })
      .catch((error) => {
        document.getElementById(
          'tablesList'
        ).innerHTML = `<div class="alert alert-error">Error loading tables: ${error.message}</div>`;
      });
  }

  function loadTableData(tableName, page = 1) {
    if (!tableName) return;

    currentTable = tableName;
    currentPage = page;

    document.getElementById('tableTitle').textContent = `üìã ${tableName} Data`;
    document.getElementById('tableSelect').value = tableName;
    document.getElementById('tableContent').innerHTML =
      '<div class="loading">Loading table data...</div>';
    document.getElementById('tableControls').style.display = 'block';

    fetch(
      `/api/database/table/${tableName}?page=${page}&per_page=${currentPerPage}`
    )
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById(
            'tableContent'
          ).innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
          return;
        }

        totalPages = data.pages;
        updatePageInfo();

        if (data.data.length === 0) {
          document.getElementById('tableContent').innerHTML =
            '<div class="alert alert-info">No data found in this table</div>';
          return;
        }

        // Create table
        let html =
          '<div class="table-container"><table class="table"><thead><tr>';
        data.columns.forEach((col) => {
          html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.data.forEach((row) => {
          html += '<tr>';
          data.columns.forEach((col) => {
            let value = row[col];
            if (value === null) value = '<em>NULL</em>';
            if (typeof value === 'string' && value.length > 100) {
              value = value.substring(0, 100) + '...';
            }

            // Format specific columns
            if (col.includes('Time') && value && value.length === 4) {
              value = formatTime(value);
            }
            if (col === 'date' && value) {
              value = formatDate(value);
            }

            html += `<td>${value}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table></div>';
        document.getElementById('tableContent').innerHTML = html;
      })
      .catch((error) => {
        document.getElementById(
          'tableContent'
        ).innerHTML = `<div class="alert alert-error">Error loading table data: ${error.message}</div>`;
      });
  }

  function executeQuery() {
    const query = document.getElementById('quickQuery').value.trim();
    if (!query) {
      showAlert('Please enter a query', 'error');
      return;
    }

    document.getElementById('tableContent').innerHTML =
      '<div class="loading">Executing query...</div>';
    document.getElementById('tableTitle').textContent = 'üîç Query Results';
    document.getElementById('tableControls').style.display = 'none';

    fetch('/api/database/query', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({query: query}),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById(
            'tableContent'
          ).innerHTML = `<div class="alert alert-error">Query Error: ${data.error}</div>`;
          return;
        }

        if (data.data.length === 0) {
          document.getElementById('tableContent').innerHTML =
            '<div class="alert alert-info">Query returned no results</div>';
          return;
        }

        // Create table for query results
        let html = `<div class="alert alert-success">Query executed successfully. ${data.count} rows returned.</div>`;
        html += '<div class="table-container"><table class="table"><thead><tr>';

        data.columns.forEach((col) => {
          html += `<th>${col}</th>`;
        });
        html += '</tr></thead><tbody>';

        data.data.forEach((row) => {
          html += '<tr>';
          data.columns.forEach((col) => {
            let value = row[col];
            if (value === null) value = '<em>NULL</em>';
            if (typeof value === 'string' && value.length > 100) {
              value = value.substring(0, 100) + '...';
            }

            // Format specific columns
            if (col.includes('Time') && value && value.length === 4) {
              value = formatTime(value);
            }
            if (col === 'date' && value) {
              value = formatDate(value);
            }

            html += `<td>${value}</td>`;
          });
          html += '</tr>';
        });

        html += '</tbody></table></div>';
        document.getElementById('tableContent').innerHTML = html;
      })
      .catch((error) => {
        document.getElementById(
          'tableContent'
        ).innerHTML = `<div class="alert alert-error">Error executing query: ${error.message}</div>`;
      });
  }

  function loadPresetQuery(queryName) {
    if (presetQueries[queryName]) {
      document.getElementById('quickQuery').value = presetQueries[queryName];
      executeQuery();
    }
  }

  function loadStats() {
    fetch('/api/database/stats')
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          document.getElementById(
            'dbStats'
          ).innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
          return;
        }

        let html = '<div class="grid grid-4">';

        // Classes stats
        html += `
                    <div class="stat-card">
                        <div class="number">${data.classes_count || 0}</div>
                        <div class="label">Total Classes</div>
                    </div>
                `;

        // Batches stats
        html += `
                    <div class="stat-card">
                        <div class="number">${data.batches_count || 0}</div>
                        <div class="label">Data Batches</div>
                    </div>
                `;

        // Diff stats
        html += `
                    <div class="stat-card">
                        <div class="number">${data.diff_count || 0}</div>
                        <div class="label">Schedule Changes</div>
                    </div>
                `;

        // Latest batch
        html += `
                    <div class="stat-card">
                        <div class="number">${
                          data.latest_batch_count || 0
                        }</div>
                        <div class="label">Latest Batch Classes</div>
                    </div>
                `;

        html += '</div>';

        // Date range info
        if (data.date_range) {
          html += '<div style="margin-top: 1rem; text-align: center;">';
          html += `<strong>Data Range:</strong> ${
            data.date_range.min || 'N/A'
          } to ${data.date_range.max || 'N/A'}`;
          if (data.latest_batch_id) {
            html += ` | <strong>Latest Batch ID:</strong> ${data.latest_batch_id}`;
          }
          html += '</div>';
        }

        document.getElementById('dbStats').innerHTML = html;
      })
      .catch((error) => {
        document.getElementById(
          'dbStats'
        ).innerHTML = `<div class="alert alert-error">Error loading stats: ${error.message}</div>`;
      });
  }

  function previousPage() {
    if (currentPage > 1) {
      loadTableData(currentTable, currentPage - 1);
    }
  }

  function nextPage() {
    if (currentPage < totalPages) {
      loadTableData(currentTable, currentPage + 1);
    }
  }

  function changePerPage(newPerPage) {
    currentPerPage = parseInt(newPerPage);
    loadTableData(currentTable, 1);
  }

  function updatePageInfo() {
    const pageInfo = document.getElementById('pageInfo');
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

    // Update button states
    const prevBtn = document.querySelector('button[onclick="previousPage()"]');
    const nextBtn = document.querySelector('button[onclick="nextPage()"]');

    if (prevBtn) prevBtn.disabled = currentPage <= 1;
    if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
  }

  function formatTime(timeStr) {
    if (!timeStr || timeStr.length !== 4) return timeStr;
    return timeStr.substring(0, 2) + ':' + timeStr.substring(2, 4);
  }
</script>
{% endblock %}
