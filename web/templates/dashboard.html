{% extends "base.html" %} {% block title %}Dashboard - ClassCompass Management{%
endblock %} {% block content %}
<div class="page-header">
  <h1>Dashboard</h1>
  <p>Overview of your ClassCompass system status and statistics</p>
</div>

<div class="grid grid-4">
  <div class="stat-card">
    <div class="number">{{ db_stats.classes_count or 0 }}</div>
    <div class="label">Total Classes</div>
  </div>

  <div class="stat-card">
    <div class="number">{{ db_stats.batches_count or 0 }}</div>
    <div class="label">Data Batches</div>
  </div>

  <div class="stat-card">
    <div class="number">{{ db_stats.diff_count or 0 }}</div>
    <div class="label">Schedule Changes</div>
  </div>

  <div class="stat-card">
    <div class="number">{{ db_stats.latest_batch_count or 0 }}</div>
    <div class="label">Latest Batch Classes</div>
  </div>
</div>

<div class="grid grid-2">
  <div class="card">
    <div class="card-header">游늶 Current Configuration</div>
    <div class="card-body">
      <div class="form-group">
        <label>Class ID:</label>
        <div class="form-control" readonly>{{ config.classID }}</div>
      </div>

      <div class="form-group">
        <label>Weeks Ahead:</label>
        <div class="form-control" readonly>{{ config.weeksAhead }}</div>
      </div>

      <div class="form-group">
        <label>Maintenance Mode:</label>
        <div class="form-control" readonly>
          {% if config.maintenance %}
          <span style="color: var(--danger-color)">游댮 Enabled</span>
          {% else %}
          <span style="color: var(--success-color)">游릭 Disabled</span>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label>Features:</label>
        <div class="form-control" readonly>
          {% if config.showCancelled %}游뛂 Show Cancelled {% endif %} {% if
          config.showChanges %}游닇 Show Changes {% endif %} {% if not
          config.showCancelled and not config.showChanges %}None enabled{% endif
          %}
        </div>
      </div>

      <a href="{{ url_for('config_page') }}" class="btn btn-primary"
        >Edit Configuration</a
      >
    </div>
  </div>

  <div class="card">
    <div class="card-header">游깷 Environment Status</div>
    <div class="card-body">
      <div class="form-group">
        <label>Calendar Integration:</label>
        <div class="form-control" readonly>
          {% if environment.calendarID %}
          <span style="color: var(--success-color)">游릭 Connected</span>
          {% else %}
          <span style="color: var(--danger-color)">游댮 Not configured</span>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label>School Connection:</label>
        <div class="form-control" readonly>
          {% if environment.cookie and environment['anonymous-school'] %}
          <span style="color: var(--success-color)"
            >游릭 {{ environment['anonymous-school'] }}</span
          >
          {% else %}
          <span style="color: var(--danger-color)">游댮 Not configured</span>
          {% endif %}
        </div>
      </div>

      <div class="form-group">
        <label>Telegram Notifications:</label>
        <div class="form-control" readonly>
          {% if environment.telegramToken and environment.telegramChat %}
          <span style="color: var(--success-color)">游릭 Enabled</span>
          {% else %}
          <span style="color: var(--danger-color)">游댮 Not configured</span>
          {% endif %}
        </div>
      </div>

      <a href="{{ url_for('environment_page') }}" class="btn btn-primary"
        >Edit Environment</a
      >
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">游늵 Database Information</div>
  <div class="card-body">
    {% if db_stats.error %}
    <div class="alert alert-error">Database Error: {{ db_stats.error }}</div>
    {% else %}
    <div class="grid grid-3">
      <div>
        <h4>Data Range</h4>
        {% if db_stats.date_range %}
        <p><strong>From:</strong> {{ db_stats.date_range.min or 'N/A' }}</p>
        <p><strong>To:</strong> {{ db_stats.date_range.max or 'N/A' }}</p>
        {% else %}
        <p>No data available</p>
        {% endif %}
      </div>

      <div>
        <h4>Latest Batch</h4>
        {% if db_stats.latest_batch_id %}
        <p><strong>Batch ID:</strong> {{ db_stats.latest_batch_id }}</p>
        <p><strong>Classes:</strong> {{ db_stats.latest_batch_count }}</p>
        {% else %}
        <p>No batches found</p>
        {% endif %}
      </div>

      <div>
        <h4>Quick Actions</h4>
        <a href="{{ url_for('database_page') }}" class="btn btn-primary"
          >View Database</a
        >
        <button onclick="refreshStats()" class="btn btn-secondary">
          Refresh Stats
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<div class="card">
  <div class="card-header">游댐 Credentials</div>
  <div class="card-body">
    <p>Edit your Google API credentials for calendar integration.</p>
    <a href="{{ url_for('edit_credentials') }}" class="btn btn-primary"
      >Edit credentials.json</a
    >
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function refreshStats() {
    showAlert('Refreshing statistics...', 'info');
    fetch('/api/database/stats')
      .then((response) => response.json())
      .then((data) => {
        if (data.error) {
          showAlert('Error refreshing stats: ' + data.error, 'error');
        } else {
          showAlert('Statistics refreshed successfully!', 'success');
          // Update the page after a short delay
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        }
      })
      .catch((error) => {
        showAlert('Error refreshing stats: ' + error.message, 'error');
      });
  }

  // Auto-refresh stats every 30 seconds
  setInterval(refreshStats, 30000);
</script>
{% endblock %}
